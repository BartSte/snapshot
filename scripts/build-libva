#!/bin/env bash
set -euo pipefail

usage="$(basename "$0") [-h] -- Compiles libva from source and 
installs it to <prefix>. The libraries will be installed to <prefix>/lib. If 
the prefix is not provided, the script will exit.

The packages managers \`apt\` and \`pacman\` are supported.

where:
    -h, --help          show this help text
    -s, --source-dir    source directory (default: ./libva)
    -p, --prefix        the prefix to install libva to (default: /usr)"

this_dir=$(dirname "$(realpath "${BASH_SOURCE:-$0}")")
src="./libva"
prefix="/usr"
while [[ $# -gt 0 ]]; do
    key="$1"
    case $key in
        -h | --help)
            echo "$usage"
            exit
            ;;
        -s | --source-dir)
            src="$2"
            shift
            shift
            ;;
        *)
            prefix="$key"
            shift
            ;;
    esac
done

if [[ -z "$prefix" ]]; then
    echo "Prefix cannot be empty"
    echo "$usage"
    exit 1
fi

src=$(realpath "$src")
prefix=$(realpath "$prefix")

install_dependencies() {
    manager="$("$this_dir/helpers/get-package-manager")"
    "${this_dir}/helpers/${manager}/install-libva-deps"
}

build_libva() {
    dir=$(pwd)
    echo "Removing path: $src"
    rm -rf "$src"
    echo "Cd to base dir $(dirname "$src")"
    cd "$(dirname "$src")"
    echo "Cloning libva with output dir: $(basename "$src")"
    git clone https://github.com/intel/libva.git "$(basename "$src")"
    echo "Cd into: $src"
    cd "$src"
    ./autogen.sh --prefix="$prefix" --libdir="$prefix/lib"
    make
    sudo make install
    cd "$dir"
}

check() {
    echo "Checking libva"
    if ! pkg-config --exists libva libva-drm libva-x11 libva-wayland; then
        echo "One of the following packages is missing: libva, libva-drm, libva-x11, libva-wayland"
        exit 1
    else
        echo "libva, libva-drm, libva-x11, and libva-wayland are installed"
    fi
}

install_dependencies
build_libva
check
